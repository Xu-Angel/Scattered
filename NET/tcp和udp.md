# TCP和UDP
## 前言
由于想写在网络小结中，但是发现内容有点过于多，违背了写网络小结的意义，就单独拧出来写一遍。
## 正文
### 一、 UDP
    UDP是一种无连接无状态的协议。
UDP有两大特性：不可靠和高效。不可靠：1）由于UDP是无连接的，就把无法确认对方的状态；2）UDP是无阻塞控制的，一直以一种恒定的速度发送报文，这就会导致经常丢包的现象；3）UDP传输数据的不可靠，由于没有确认和重传机制，传输的数据不能保证是完整可靠的。高效：1）UDP报文的头部只有8字节，非常小对于数据传输效率有很大的提升；2）UDP实现简单，没有复杂的确认、重传机制，数据传输效率高。UDP的传输方式比较多样化，支持n对n(n>=1),也就是支持单播、多播和广播。现在大多数实时性比较高的数据传输(直播、通话等)都依赖UDP。
### 二、TCP
    TCP是一种面向连接无状态的协议，能够实现全双工通讯。

#### 1.TCP的头部（比较复杂）
- Sequence number：使得传输的报文有序，便于后续的拼接以及指定那些报文需要重传
- Acknowledgement Numbe： 表示接收端期望传输的一个报文的序号，也表示上一个序号已经接受到
- Window Size： 表示接收端还能接受多少字节，用于流量控制
- 标准符（这里主要简介后续会涉及到的）

    - ACK：ACK = 1表示确认好字段有效
    - SYN：当SYN = 1、ACK = 0表示该报文为连接请求报文，当SYN = 1、ACK = 1表示该报文为同意建立连接的应答报文
    - FIN：FIN = 1表示该报文为释放连接的请求报文
#### 2. 三次握手
起初两端状态都是CLOSED,然后双方都开始建立TCB，服务端建立完后则会进入LINSTEN状态；第一次握手：客户端发送一个连接请求报文（SYN = 1,ACK = 0，然后客户端进入SYN-SENT状态；第二次握手：服务端接受到请求后，如果同意连接，会发送一个同意建立连接的应答报文（SYN = 1,ACK = 1),然后进入SYN-RECEIVED状态；第三次握手：客户端接受到应答报文好，会回复一个确认报文（ACK=1），客户端则进入ESTABLISHED状态，而服务端接受到确认报文以后也进入ESTABLISHED状态。

>PS为什么要进行第三次应答：目的是为了节约资源，避免不必要的等待，由于网络环境问题，有时候会出现重新发送连接请求报文，如果第一个请求在第二个请求已经到达且后续已经走完建立连接且又已经关闭连接的情况下到达服务器端，服务器就又会进入ESTABLISHED状态，而客户端则会是COLSED状态，这样会导致服务器以为连接已经建立，一直等待客户端发送请求。

<div align=center>
    <img width='500' src='./image/03.jpg'>
</div>

#### 3. 四次挥手
由于TCP是全双工通讯的，所以两边都要发送FIN和ACK。第一次挥手：客户端已经数据传输完毕会发送一个释放连接的请求；第二次挥手：服务端接受到上一个请求后，会告诉应用层要释放TCP连接，然后会发送一个确认关闭的应答（ACK = 1）,并进入Close_Wait状态，表示客户端到服务端的连接已经释放，但是服务端到客户端还是能发送数据（由于全双工通讯）；第三次挥手：服务端如果还有未发送完的数据，则会在数据发送完后（在双方规定的时间内发送完，否则客户端会以为需要重传数据），向客户端发送释放请求报文，然后服务端进入LAST_ACK状态；第四挥手：客户端接受到释放请求连接后，会发送一个确认报文（ACK=1)，然后会进入一个TIME_WAIT状态，在2MSL（MSL:最大段生存期，指报文段在网络中最大生存时间，如果超时则会被抛弃）后，没有收到服务端的重新发送的请求化，会进入CLOSE状态，服务端在接受到确认请求后也进入CLOSE状态。

>ps为什么客户端要等待2MSL：如果客户端直接进入COLSE状态，而服务端由于网络原因没有接受到确认报文，服务端会以为客户端没有接受到释放连接报文则会重新发送，而此时客户端就不会做出应答，服务端一直走这个死循环，导致资源的浪费。

<div align=center>
    <img width='500' src='./image/04.png'>
</div>

#### 4.重传机制——ARQ协议
ARQ协议也就是超时重传机制，通过确认和超时重传来确保数据的正确送达。ARQ协议有两种机制实现。一是停止等待ARQ，顾名思义在没有收到对方的确认报文直接会一直等待，而等待时间一般会大于一个RTT(报文从发送端发送数据到接收端接受数据需要的往返时间)，计时开始是在发送端开始发送数据开始计算，在规定时间内容没有收到确认报文，则会重传，这个协议缺点就是传输效率低，每次都要进行停止传输等待ACK回复；二是连续ARQ，顾名思义就是连续发送报文，统一回复，具体是发送端会有一个发送窗口，在没有收到确认报文之前一直发送发送窗口的数据，而接收端可以统一回复，通过回复报文里的序号字段表示这个序号之前都已经成功接收，只需要发送序号+1的报文即可，这样就避免了频繁的等待，提高了传输效率，但是如果某一个报文传输出错，就会发送该报文序号-1的确认报文，而已经传输的序号+n的报文就要重新传输，可以说可靠性不如停止等待ARQ。

#### 5.流量控制
TCP的流量控制通过滑动窗口实现，两端都有维护一个窗口，发送端窗口是包含已发送但未确认的数据和可以发送但未发送的数据，而接收端窗口包含的是还可以接受多少数据信息，每次接收端发送的确认报文中会包含还能接受多少数据的信息，然后移动端窗口会滑动窗口，移动已发送但未确认的数据的大小，并根据确认报文中的接收端还能接受数据量，来完成窗口大小控制，这样就达到了流量控制，使得数据不会再接收端阻塞。零窗口的需求：如果接收端窗口为零，那么发送端将不会发送数据，并启用一个计时器，在该时间段内，不断去发送请求给对端来询问窗口大小，如果达到一定的次数还是为零，那么可能会断开TCP连接。

<div align=center>
    <img width='600' src='./image/05.jpg'>
</div>

#### 6.拥塞处理
拥塞处理是面向网络防止网络阻塞，而流量控制是面向接收端防止数据接收不过来，拥塞处理的大致方法是通过设置阈值，在发送数据速度大于阈值时会对发送数据进行重定义，并为发送速度定义一些增长算法，来使得发送速度能够跟的上网络的流量的处理能力。拥塞处理包括了四个算法，分别为：慢开始，拥塞避免，快速重传，快速恢复。
## 参考文章
- [计算机通识](https://yuchengkai.cn/docs/zh/cs/)